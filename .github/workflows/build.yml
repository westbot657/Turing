name: CI Build and Release

on:
    push:
        branches:
            - master
        tags:
            - "v*"
    pull_request:
    workflow_dispatch:

jobs:
    build:
        name: Build and test (${{ matrix.os_name }} - ${{ matrix.arch }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      os_name: linux
                      arch: x86_64
                      target: x86_64-unknown-linux-gnu
                      artifact: libturing.so
                    - os: windows-latest
                      os_name: windows
                      arch: x86_64
                      target: x86_64-pc-windows-msvc
                      artifact: turing.dll

                

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  profile: minimal
                  override: true

            - name: Show Rust version
              run: rustc --version

            - name: Run tests
              run: cargo test --all --verbose

            - name: Build release
              run: cargo build --release --verbose



            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: turing-${{ matrix.os_name }}-${{ matrix.arch }}
                  path: |
                    target/release/${{ matrix.artifact }}

    publish:
        name: Publish release
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download Linux build artifact
              uses: actions/download-artifact@v4
              with:
                  name: turing-linux-x86_64
                  path: downloaded/linux-x86_64

            - name: Download Windows build artifact
              uses: actions/download-artifact@v4
              with:
                  name: turing-windows-x86_64
                  path: downloaded/windows-x86_64

            - name: Create GitHub Release and upload binaries
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                    downloaded/linux/*
                    downloaded/windows-x86_64/*
